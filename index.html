<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Background Remover with Text and Download</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        canvas {
            border: 2px solid #000;
        }
        #controls {
            margin-top: 10px;
        }
        img {
            max-width: 100%;
            height: auto;
            display: none;
        }
        #textControls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>AI Background Remover with Text and Download</h1>

    <!-- File Input for Image Upload -->
    <input type="file" id="upload" accept="image/*" />
    <br>

    <!-- Background options -->
    <label for="bgColor">Select background color: </label>
    <input type="color" id="bgColor" value="#ffffff" />

    <br>

    <label for="bgUpload">Or upload a background image: </label>
    <input type="file" id="bgUpload" accept="image/*" />
    
    <!-- Text input for adding text -->
    <div id="textControls">
        <input type="text" id="textInput" placeholder="Enter text to add" />
        <button id="addTextButton">Add Text</button>
    </div>

    <!-- Canvas for displaying the final image -->
    <canvas id="canvas" width="800" height="600"></canvas>

    <!-- Control buttons -->
    <div id="controls">
        <button id="removeBgButton">Remove Background</button>
        <button id="applyBgButton">Apply New Background</button>
        <button id="downloadImage">Download Image</button>
        <button id="clearCanvas">Clear Canvas</button>
    </div>

    <!-- Include Fabric.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>

    <script>
        var canvas = new fabric.Canvas('canvas');
        var image, backgroundRect;
        var apiKey = "9oAu2k64ATeVCwdip2bcS8ch"; // Replace with your remove.bg API key

        // Handle image upload
        document.getElementById('upload').onchange = function (e) {
            var reader = new FileReader();
            reader.onload = function (event) {
                var imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function () {
                    image = new fabric.Image(imgObj);
                    image.set({
                        left: 100,
                        top: 100,
                        angle: 0,
                        padding: 10,
                        cornersize: 10,
                    });
                    canvas.add(image);
                    canvas.setActiveObject(image);
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // Remove background using remove.bg API
        document.getElementById('removeBgButton').onclick = function () {
            var fileInput = document.getElementById('upload');
            if (fileInput.files.length === 0) {
                alert("Please upload an image first.");
                return;
            }

            var formData = new FormData();
            formData.append("image_file", fileInput.files[0]);

            fetch("https://api.remove.bg/v1.0/removebg", {
                method: "POST",
                headers: {
                    "X-Api-Key": apiKey
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to remove background: " + response.statusText);
                }
                return response.blob();
            })
            .then(blob => {
                var imgURL = URL.createObjectURL(blob);
                fabric.Image.fromURL(imgURL, function (img) {
                    canvas.clear(); // Clear existing canvas content
                    canvas.add(img); // Add the image with removed background
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        };

        // Apply background color or image
        document.getElementById('applyBgButton').onclick = function () {
            var bgColor = document.getElementById('bgColor').value;
            var bgFileInput = document.getElementById('bgUpload');

            // Clear existing background if any
            if (backgroundRect) {
                canvas.remove(backgroundRect);
            }

            if (bgFileInput.files.length > 0) {
                // If a background image is uploaded
                var reader = new FileReader();
                reader.onload = function (event) {
                    fabric.Image.fromURL(event.target.result, function (img) {
                        img.set({
                            left: 0,
                            top: 0,
                            selectable: false,
                            width: canvas.width,
                            height: canvas.height
                        });
                        canvas.add(img);
                        canvas.sendToBack(img); // Send background image to back
                    });
                };
                reader.readAsDataURL(bgFileInput.files[0]);
            } else {
                // If a background color is selected
                backgroundRect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: canvas.width,
                    height: canvas.height,
                    fill: bgColor,
                    selectable: false
                });
                canvas.add(backgroundRect);
                canvas.sendToBack(backgroundRect); // Send color rectangle to back
            }
        };

        // Add text to the canvas
        document.getElementById('addTextButton').onclick = function () {
            var textValue = document.getElementById('textInput').value;
            if (textValue.trim() === "") {
                alert("Please enter some text.");
                return;
            }

            var text = new fabric.Text(textValue, {
                left: 150,
                top: 150,
                fontSize: 30,
                fill: '#000000'
            });
            canvas.add(text);
        };

        // Download image
        document.getElementById('downloadImage').onclick = function () {
            var link = document.createElement('a');
            link.href = canvas.toDataURL({
                format: 'png',
                quality: 1
            });
            link.download = 'edited-image.png';
            link.click();
        };

        // Clear canvas
        document.getElementById('clearCanvas').onclick = function () {
            canvas.clear();
        };
    </script>
</body>
</html>
